module.exports=[57161,(e,t,a)=>{t.exports=e.x("@prisma/client-5551ed320f9fac8d",()=>require("@prisma/client-5551ed320f9fac8d"))},54969,e=>e.a(async(t,a)=>{try{let t=await e.y("pg-0af994d0a334f027");e.n(t),a()}catch(e){a(e)}},!0),93695,(e,t,a)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},18622,(e,t,a)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},70406,(e,t,a)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},21060,e=>e.a(async(t,a)=>{try{var r=e.i(52613),s=t([r]);async function n(e,t){let a=new Date(t);a.setHours(0,0,0,0);let s=new Date(t);s.setHours(23,59,59,999);let[n,i,l]=await Promise.all([r.prisma.purchase.aggregate({where:{sellerId:e,status:"COMPLETED",createdAt:{gte:a,lte:s}},_sum:{sellerReceives:!0},_count:!0}),r.prisma.session.aggregate({where:{sellerId:e,createdAt:{gte:a,lte:s}},_count:!0}),r.prisma.$queryRaw`
      SELECT COUNT(DISTINCT p."buyerId") as count
      FROM "Purchase" p
      WHERE p."sellerId" = ${e}
        AND p.status = 'COMPLETED'
        AND p."createdAt" >= ${a}
        AND p."createdAt" <= ${s}
        AND NOT EXISTS (
          SELECT 1 FROM "Purchase" p2
          WHERE p2."buyerId" = p."buyerId"
            AND p2."sellerId" = ${e}
            AND p2.status = 'COMPLETED'
            AND p2."createdAt" < ${a}
        )
    `]),o=await r.prisma.session.count({where:{sellerId:e,status:{in:["COMPLETED","AWAITING_CONFIRMATION","PAID_OUT","RATED"]},completedAt:{gte:a,lte:s}}});await r.prisma.sellerDailyStats.upsert({where:{sellerId_date:{sellerId:e,date:a}},update:{revenue:n._sum.sellerReceives||0,purchases:n._count,sessions:i._count,completedSessions:o,newBuyers:Number(l[0]?.count||0)},create:{sellerId:e,date:a,revenue:n._sum.sellerReceives||0,purchases:n._count,sessions:i._count,completedSessions:o,newBuyers:Number(l[0]?.count||0)}})}async function i(e,t=90){let a=new Date,r=new Date(a);r.setDate(r.getDate()-t);for(let t=new Date(r);t<=a;t.setDate(t.getDate()+1))await n(e,new Date(t))}async function l(e){let t=await r.prisma.buyerAnalytics.findMany({where:{sellerId:e}}),a=Date.now();for(let e of t){let t=Math.floor((a-e.lastPurchaseAt.getTime())/864e5),s="low";t>90?s="high":t>30&&(s="medium"),e.churnRisk!==s&&await r.prisma.buyerAnalytics.update({where:{id:e.id},data:{churnRisk:s}})}}async function o(e){let t=await r.prisma.buyerAnalytics.findMany({where:{sellerId:e}}),a=t.length,s=t.filter(e=>e.totalPurchases>1).length,n=[];for(let e of t)if(e.totalPurchases>1){let t=Math.floor((e.lastPurchaseAt.getTime()-e.firstPurchaseAt.getTime())/864e5);n.push(t/(e.totalPurchases-1))}let i=n.length>0?n.reduce((e,t)=>e+t,0)/n.length:null,l=t.filter(e=>"high"===e.churnRisk).length,o=t.reduce((e,t)=>e+t.totalSessions,0),u=t.reduce((e,t)=>e+t.completedSessions,0),c=t.filter(e=>e.totalSessions>1).length,d=[],p=new Date;for(let e=5;e>=0;e--){let a=new Date(p.getFullYear(),p.getMonth()-e,1),r=new Date(p.getFullYear(),p.getMonth()-e+1,0),s=t.filter(e=>e.firstPurchaseAt>=a&&e.firstPurchaseAt<=r),n=new Date(p);n.setDate(n.getDate()-30);let i=s.filter(e=>e.lastPurchaseAt>=n).length;d.push({month:a.toISOString().slice(0,7),totalBuyers:s.length,stillActive:i,retention:s.length>0?i/s.length:0})}let h=t.map(e=>e.lifetimeValue).sort((e,t)=>e-t),f=h.length>0?h.reduce((e,t)=>e+t,0)/h.length:0,y=h.length>0?h[Math.floor(h.length/2)]:0,g=Math.floor(.9*h.length),m=h.length>0&&h[g]||0;return{repeatBuyerRate:a>0?s/a:0,averageRepurchaseTimeDays:i,buyerChurnRate:a>0?l/a:0,sessionCompletionRate:o>0?u/o:0,rebookingRate:a>0?c/a:0,cohorts:d,buyerLifetimeValue:{average:f,median:y,top10Percent:m}}}async function u(e,t="daily",a=30){let s=new Date,n=new Date;n.setDate(n.getDate()-a);let i=await r.prisma.sellerDailyStats.findMany({where:{sellerId:e,date:{gte:n,lte:s}},orderBy:{date:"asc"}}),l=i.reduce((e,t)=>e+t.revenue,0),o=new Date(n);o.setDate(o.getDate()-1);let c=new Date(o);c.setDate(c.getDate()-a);let d=(await r.prisma.sellerDailyStats.findMany({where:{sellerId:e,date:{gte:c,lte:o}}})).reduce((e,t)=>e+t.revenue,0),p=[];if("daily"===t)for(let e of i)p.push({date:e.date.toISOString().slice(0,10),revenue:e.revenue,purchases:e.purchases,sessions:e.sessions});else if("weekly"===t){let e=new Map;for(let t of i){let a=(function(e){let t=new Date(e),a=t.getDay(),r=t.getDate()-a;return t.setDate(r),t.setHours(0,0,0,0),t})(t.date).toISOString().slice(0,10);e.has(a)||e.set(a,{date:a,revenue:0,purchases:0,sessions:0});let r=e.get(a);r.revenue+=t.revenue,r.purchases+=t.purchases,r.sessions+=t.sessions}p.push(...Array.from(e.values()))}else{let e=new Map;for(let t of i){let a=t.date.toISOString().slice(0,7);e.has(a)||e.set(a,{date:a,revenue:0,purchases:0,sessions:0});let r=e.get(a);r.revenue+=t.revenue,r.purchases+=t.purchases,r.sessions+=t.sessions}p.push(...Array.from(e.values()))}return{totalRevenue:l,periodComparison:{current:l,previous:d,changePercent:d>0?(l-d)/d*100:0},chartData:p}}async function c(e,t=10,a="all"){let s;"year"===a?(s=new Date).setFullYear(s.getFullYear()-1):"month"===a&&(s=new Date).setMonth(s.getMonth()-1);let n=await r.prisma.buyerAnalytics.findMany({where:{sellerId:e,...s?{lastPurchaseAt:{gte:s}}:{}},orderBy:{totalSpent:"desc"},take:t}),i=n.map(e=>e.buyerId),l=await r.prisma.user.findMany({where:{id:{in:i}},select:{id:!0,name:!0,avatar:!0}}),o=new Map(l.map(e=>[e.id,e]));return n.map(e=>{let t=o.get(e.buyerId);return{buyerId:e.buyerId,buyerName:t?.name||null,buyerAvatar:t?.avatar||null,totalSpent:e.totalSpent,totalSessions:e.totalSessions,lastPurchaseAt:e.lastPurchaseAt}})}async function d(e){let t=await r.prisma.session.findMany({where:{sellerId:e,scheduledAt:{not:null}},select:{scheduledAt:!0}}),a=new Map,s=new Map,n=new Map;for(let e of t){if(!e.scheduledAt)continue;let t=e.scheduledAt.getHours(),r=e.scheduledAt.getDay();a.set(t,(a.get(t)||0)+1),s.set(r,(s.get(r)||0)+1),n.set(`${r}-${t}`,(n.get(`${r}-${t}`)||0)+1)}let i=Array.from(a.entries()).map(([e,t])=>({hour:e,count:t})).sort((e,t)=>t.count-e.count),l=Array.from(s.entries()).map(([e,t])=>({day:e,count:t})).sort((e,t)=>t.count-e.count),o=Array.from(n.entries()).map(([e,t])=>{let[a,r]=e.split("-").map(Number);return{day:a,hour:r,count:t}});return{peakHours:i,peakDays:l,heatmap:o}}async function p(e,t={}){let{sort:a="totalSpent",churnRisk:s,minSpent:n,limit:i=20,cursor:l}=t,o=await r.prisma.buyerAnalytics.findMany({where:{sellerId:e,...s?{churnRisk:s}:{},...n?{totalSpent:{gte:n}}:{},...l?{id:{gt:l}}:{}},orderBy:{[a]:"desc"},take:i+1}),u=o.length>i;u&&o.pop();let c=o.map(e=>e.buyerId),d=await r.prisma.user.findMany({where:{id:{in:c}},select:{id:!0,name:!0,avatar:!0}}),h=new Map(d.map(e=>[e.id,e]));return{buyers:o.map(e=>{let t=h.get(e.buyerId);return{buyerId:e.buyerId,buyerName:t?.name||null,buyerAvatar:t?.avatar||null,firstPurchaseAt:e.firstPurchaseAt,lastPurchaseAt:e.lastPurchaseAt,totalPurchases:e.totalPurchases,totalSpent:e.totalSpent,totalSessions:e.totalSessions,completedSessions:e.completedSessions,lifetimeValue:e.lifetimeValue,churnRisk:e.churnRisk}}),nextCursor:u?o[o.length-1].id:null}}[r]=s.then?(await s)():s,e.s(["assessChurnRiskForSeller",()=>l,"backfillDailyStats",()=>i,"computeRetentionMetrics",()=>o,"fetchBuyerInsights",()=>p,"fetchPeakTimes",()=>d,"fetchRevenueAnalytics",()=>u,"fetchTopBuyers",()=>c]),a()}catch(e){a(e)}},!1),80325,e=>e.a(async(t,a)=>{try{var r=e.i(39660),s=e.i(52613),n=e.i(83974),i=e.i(21060),l=t([s,i]);async function o(e){try{let{userId:t}=await n.whopsdk.verifyUserToken(e.headers),a=await s.prisma.user.findUnique({where:{whopUserId:t},include:{sellerProfile:!0}});if(!a)return r.NextResponse.json({error:"User not found"},{status:404});if(!a.sellerProfile)return r.NextResponse.json({error:"Seller profile not found"},{status:404});let{searchParams:l}=new URL(e.url),o=l.get("period")||"daily",u=parseInt(l.get("days")||"30",10),c=await s.prisma.sellerDailyStats.count({where:{sellerId:a.id}});0===c&&await (0,i.backfillDailyStats)(a.id,u);let d=await (0,i.fetchRevenueAnalytics)(a.id,o,u);return r.NextResponse.json(d)}catch(e){return console.error("Error fetching revenue analytics:",e),r.NextResponse.json({error:"Failed to fetch revenue analytics"},{status:500})}}[s,i]=l.then?(await l)():l,e.s(["GET",()=>o]),a()}catch(e){a(e)}},!1),95577,e=>e.a(async(t,a)=>{try{var r=e.i(13348),s=e.i(41275),n=e.i(34648),i=e.i(75319),l=e.i(32964),o=e.i(43172),u=e.i(49870),c=e.i(70891),d=e.i(98634),p=e.i(23259),h=e.i(39185),f=e.i(34505),y=e.i(19549),g=e.i(52060),m=e.i(84024),w=e.i(93695);e.i(42630);var v=e.i(4945),R=e.i(80325),A=t([R]);[R]=A.then?(await A)():A;let E=new r.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/sellers/analytics/revenue/route",pathname:"/api/sellers/analytics/revenue",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/waliet/app/api/sellers/analytics/revenue/route.ts",nextConfigOutput:"",userland:R}),{workAsyncStorage:S,workUnitAsyncStorage:b,serverHooks:P}=E;function x(){return(0,n.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:b})}async function D(e,t,a){E.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/sellers/analytics/revenue/route";r=r.replace(/\/index$/,"")||"/";let n=await E.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:R,params:A,nextConfig:x,parsedUrl:D,isDraftMode:S,prerenderManifest:b,routerServerContext:P,isOnDemandRevalidate:C,revalidateOnlyGenerated:T,resolvedPathname:I,clientReferenceManifest:N,serverActionsManifest:M}=n,O=(0,u.normalizeAppPath)(r),k=!!(b.dynamicRoutes[O]||b.routes[I]),_=async()=>((null==P?void 0:P.render404)?await P.render404(e,t,D,!1):t.end("This page could not be found"),null);if(k&&!S){let e=!!b.routes[I],t=b.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await _();throw new w.NoFallbackError}}let q=null;!k||E.isDev||S||(q=I,q="/index"===q?"/":q);let H=!0===E.isDev||!k,U=k&&!H;M&&N&&(0,o.setManifestsSingleton)({page:r,clientReferenceManifest:N,serverActionsManifest:M});let j=e.method||"GET",$=(0,l.getTracer)(),F=$.getActiveScopeSpan(),B={params:A,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r,s)=>E.onRequestError(e,t,r,s,P)},sharedContext:{buildId:R}},L=new c.NodeNextRequest(e),K=new c.NodeNextResponse(t),V=d.NextRequestAdapter.fromNodeNextRequest(L,(0,d.signalFromNodeResponse)(t));try{let n=async e=>E.handle(V,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=$.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=a.get("next.route");if(s){let t=`${j} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${r}`)}),o=!!(0,i.getRequestMeta)(e,"minimalMode"),u=async i=>{var l,u;let c=async({previousCacheEntry:s})=>{try{if(!o&&C&&T&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await n(i);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let u=B.renderOpts.collectedTags;if(!k)return await (0,f.sendResponse)(L,K,r,B.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,y.toNodeOutgoingHttpHeaders)(r.headers);u&&(t[m.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,s=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:s}}}}catch(t){throw(null==s?void 0:s.isStale)&&await E.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:C})},!1,P),t}},d=await E.handleResponse({req:e,nextConfig:x,cacheKey:q,routeKind:s.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:T,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:o});if(!k)return null;if((null==d||null==(l=d.value)?void 0:l.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(u=d.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",C?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,y.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&k||p.delete(m.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,g.getCacheControlHeader)(d.cacheControl)),await (0,f.sendResponse)(L,K,new Response(d.value.body,{headers:p,status:d.value.status||200})),null};F?await u(F):await $.withPropagatedContext(e.headers,()=>$.trace(p.BaseServerSpan.handleRequest,{spanName:`${j} ${r}`,kind:l.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},u))}catch(t){if(t instanceof w.NoFallbackError||await E.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:C})},!1,P),k)throw t;return await (0,f.sendResponse)(L,K,new Response(null,{status:500})),null}}e.s(["handler",()=>D,"patchFetch",()=>x,"routeModule",()=>E,"serverHooks",()=>P,"workAsyncStorage",()=>S,"workUnitAsyncStorage",()=>b]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__98bc7dac._.js.map