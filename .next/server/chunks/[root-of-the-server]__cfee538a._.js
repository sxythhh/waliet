module.exports=[57161,(e,t,r)=>{t.exports=e.x("@prisma/client-5551ed320f9fac8d",()=>require("@prisma/client-5551ed320f9fac8d"))},54969,e=>e.a(async(t,r)=>{try{let t=await e.y("pg-0af994d0a334f027");e.n(t),r()}catch(e){r(e)}},!0),93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},36867,e=>{"use strict";function t(e){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(e/100)}function r(e,t){return Math.round(t/1e4*e)}function o(e,t=800){return r(e,t)}function s(e,t){return r(e,t)}function n(e){return new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"}).format(new Date(e))}e.s(["DEFAULT_COMMUNITY_FEE_BPS",0,500,"DEFAULT_PLATFORM_FEE_BPS",0,800,"MAX_TOTAL_FEE_BPS",0,9e3,"calculateCommunityFee",()=>s,"calculateFeeFromBps",()=>r,"calculatePlatformFee",()=>o,"formatCents",()=>t,"formatDateTime",()=>n],36867)},38979,e=>e.a(async(t,r)=>{try{var o=e.i(52613),s=e.i(36867),n=t([o]);async function a(e,t){let[r,n]=await Promise.all([o.prisma.sellerProfile.findFirst({where:{userId:e},select:{customPlatformFeeBps:!0,customCommunityFeeBps:!0}}),t?o.prisma.communityConfig.findUnique({where:{whopCompanyId:t},select:{customPlatformFeeBps:!0,communityFeeBps:!0}}):null]),a=s.DEFAULT_PLATFORM_FEE_BPS,i="default";r?.customPlatformFeeBps!==null&&r?.customPlatformFeeBps!==void 0?(a=r.customPlatformFeeBps,i="seller"):n?.customPlatformFeeBps!==null&&n?.customPlatformFeeBps!==void 0&&(a=n.customPlatformFeeBps,i="community");let l=s.DEFAULT_COMMUNITY_FEE_BPS,m="default";return r?.customCommunityFeeBps!==null&&r?.customCommunityFeeBps!==void 0?(l=r.customCommunityFeeBps,m="seller"):n?.communityFeeBps!==null&&n?.communityFeeBps!==void 0&&(l=n.communityFeeBps,m="community"),{platformFeeBps:a,communityFeeBps:l,totalFeeBps:a+l,source:{platform:i,community:m}}}function i(e,t){if(e<0||t<0)return{valid:!1,error:"Commission rates cannot be negative"};if(e>s.MAX_TOTAL_FEE_BPS)return{valid:!1,error:`Platform fee cannot exceed ${s.MAX_TOTAL_FEE_BPS/100}%`};if(t>s.MAX_TOTAL_FEE_BPS)return{valid:!1,error:`Community fee cannot exceed ${s.MAX_TOTAL_FEE_BPS/100}%`};let r=e+t;return r>s.MAX_TOTAL_FEE_BPS?{valid:!1,error:`Total fees (${r/100}%) cannot exceed ${s.MAX_TOTAL_FEE_BPS/100}%`}:{valid:!0}}async function l(e,t,r,n,a){let l=await o.prisma.sellerProfile.findUnique({where:{id:e},select:{customPlatformFeeBps:!0,customCommunityFeeBps:!0}});if(!l)throw Error("Seller profile not found");let m="platform"===t?l.customPlatformFeeBps:l.customCommunityFeeBps;if(null!==r){let e="platform"===t?l.customCommunityFeeBps??s.DEFAULT_COMMUNITY_FEE_BPS:l.customPlatformFeeBps??s.DEFAULT_PLATFORM_FEE_BPS,o=i("platform"===t?r:e,"community"===t?r:e);if(!o.valid)throw Error(o.error)}await o.prisma.$transaction([o.prisma.sellerProfile.update({where:{id:e},data:{..."platform"===t?{customPlatformFeeBps:r}:{customCommunityFeeBps:r},commissionUpdatedAt:new Date,commissionUpdatedBy:n}}),o.prisma.commissionChange.create({data:{sellerProfileId:e,feeType:t,previousBps:m,newBps:r,reason:a,changedBy:n}})])}async function m(e,t,r,n,a){let l=await o.prisma.communityConfig.findUnique({where:{id:e},select:{customPlatformFeeBps:!0,communityFeeBps:!0}});if(!l)throw Error("Community config not found");let m="platform"===t?l.customPlatformFeeBps:l.communityFeeBps;if(null!==r){let e="platform"===t?l.communityFeeBps:l.customPlatformFeeBps??s.DEFAULT_PLATFORM_FEE_BPS,o=i("platform"===t?r:e,"community"===t?r:e);if(!o.valid)throw Error(o.error)}await o.prisma.$transaction([o.prisma.communityConfig.update({where:{id:e},data:"platform"===t?{customPlatformFeeBps:r}:{communityFeeBps:r??s.DEFAULT_COMMUNITY_FEE_BPS}}),o.prisma.commissionChange.create({data:{communityConfigId:e,feeType:t,previousBps:m,newBps:r,reason:a,changedBy:n}})])}[o]=n.then?(await n)():n,e.s(["getEffectiveCommissionRates",()=>a,"setCommunityCommissionRate",()=>m,"setSellerCommissionRate",()=>l,"validateCommissionRates",()=>i]),r()}catch(e){r(e)}},!1),74804,e=>e.a(async(t,r)=>{try{var o=e.i(39660),s=e.i(52613),n=e.i(83974),a=e.i(38979),i=e.i(36867),l=e.i(12230),m=t([s,a]);[s,a]=m.then?(await m)():m;let d=l.z.object({targetType:l.z.enum(["seller","community"]),targetId:l.z.string().min(1),feeType:l.z.enum(["platform","community"]),newBps:l.z.number().int().min(0).max(9e3).nullable(),reason:l.z.string().max(500).optional()});async function u(e){try{let{userId:t}=await n.whopsdk.verifyUserToken(e.headers);if(!await s.prisma.user.findUnique({where:{whopUserId:t}}))return o.NextResponse.json({error:"User not found"},{status:404});let[r,a,l]=await Promise.all([s.prisma.sellerProfile.findMany({where:{OR:[{customPlatformFeeBps:{not:null}},{customCommunityFeeBps:{not:null}}]},select:{id:!0,customPlatformFeeBps:!0,customCommunityFeeBps:!0,commissionNotes:!0,commissionUpdatedAt:!0,commissionUpdatedBy:!0,user:{select:{id:!0,name:!0,email:!0}}},orderBy:{commissionUpdatedAt:"desc"}}),s.prisma.communityConfig.findMany({where:{OR:[{customPlatformFeeBps:{not:null}},{communityFeeBps:{not:i.DEFAULT_COMMUNITY_FEE_BPS}}]},select:{id:!0,whopCompanyId:!0,customPlatformFeeBps:!0,communityFeeBps:!0},orderBy:{updatedAt:"desc"}}),s.prisma.commissionChange.findMany({take:50,orderBy:{createdAt:"desc"},include:{sellerProfile:{select:{user:{select:{id:!0,name:!0}}}},communityConfig:{select:{whopCompanyId:!0}}}})]);return o.NextResponse.json({defaults:{platformFeeBps:i.DEFAULT_PLATFORM_FEE_BPS,communityFeeBps:i.DEFAULT_COMMUNITY_FEE_BPS},sellers:r.map(e=>({id:e.id,userId:e.user.id,userName:e.user.name,userEmail:e.user.email,customPlatformFeeBps:e.customPlatformFeeBps,customCommunityFeeBps:e.customCommunityFeeBps,notes:e.commissionNotes,updatedAt:e.commissionUpdatedAt,updatedBy:e.commissionUpdatedBy})),communities:a.map(e=>({id:e.id,whopCompanyId:e.whopCompanyId,customPlatformFeeBps:e.customPlatformFeeBps,communityFeeBps:e.communityFeeBps})),recentChanges:l.map(e=>({id:e.id,targetType:e.sellerProfileId?"seller":"community",targetId:e.sellerProfileId||e.communityConfigId,targetName:e.sellerProfile?.user?.name||e.communityConfig?.whopCompanyId||"Unknown",feeType:e.feeType,previousBps:e.previousBps,newBps:e.newBps,reason:e.reason,changedBy:e.changedBy,createdAt:e.createdAt}))})}catch(e){return console.error("Error fetching commissions:",e),o.NextResponse.json({error:"Failed to fetch commissions"},{status:500})}}async function c(e){try{let{userId:t}=await n.whopsdk.verifyUserToken(e.headers),r=await s.prisma.user.findUnique({where:{whopUserId:t}});if(!r)return o.NextResponse.json({error:"User not found"},{status:404});let l=await e.json(),{targetType:m,targetId:u,feeType:c,newBps:p,reason:f}=d.parse(l);if(null!==p)if("seller"===m){let e=await s.prisma.sellerProfile.findUnique({where:{id:u},select:{customPlatformFeeBps:!0,customCommunityFeeBps:!0}});if(!e)return o.NextResponse.json({error:"Seller profile not found"},{status:404});let t="platform"===c?p:e.customPlatformFeeBps??i.DEFAULT_PLATFORM_FEE_BPS,r="community"===c?p:e.customCommunityFeeBps??i.DEFAULT_COMMUNITY_FEE_BPS,n=(0,a.validateCommissionRates)(t,r);if(!n.valid)return o.NextResponse.json({error:n.error},{status:400})}else{let e=await s.prisma.communityConfig.findUnique({where:{id:u},select:{customPlatformFeeBps:!0,communityFeeBps:!0}});if(!e)return o.NextResponse.json({error:"Community config not found"},{status:404});let t="platform"===c?p:e.customPlatformFeeBps??i.DEFAULT_PLATFORM_FEE_BPS,r="community"===c?p:e.communityFeeBps,n=(0,a.validateCommissionRates)(t,r);if(!n.valid)return o.NextResponse.json({error:n.error},{status:400})}return"seller"===m?await (0,a.setSellerCommissionRate)(u,c,p,r.id,f):await (0,a.setCommunityCommissionRate)(u,c,p,r.id,f),o.NextResponse.json({success:!0})}catch(e){if(console.error("Error setting commission:",e),e instanceof l.z.ZodError)return o.NextResponse.json({error:"Invalid request data",details:e.issues},{status:400});if(e instanceof Error)return o.NextResponse.json({error:e.message},{status:400});return o.NextResponse.json({error:"Failed to set commission"},{status:500})}}e.s(["GET",()=>u,"POST",()=>c]),r()}catch(e){r(e)}},!1),84419,e=>e.a(async(t,r)=>{try{var o=e.i(13348),s=e.i(41275),n=e.i(34648),a=e.i(75319),i=e.i(32964),l=e.i(43172),m=e.i(49870),u=e.i(70891),c=e.i(98634),d=e.i(23259),p=e.i(39185),f=e.i(34505),y=e.i(19549),F=e.i(52060),h=e.i(84024),E=e.i(93695);e.i(42630);var B=e.i(4945),P=e.i(74804),w=t([P]);[P]=w.then?(await w)():w;let x=new o.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/admin/commissions/route",pathname:"/api/admin/commissions",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/waliet/app/api/admin/commissions/route.ts",nextConfigOutput:"",userland:P}),{workAsyncStorage:_,workUnitAsyncStorage:T,serverHooks:v}=x;function C(){return(0,n.patchFetch)({workAsyncStorage:_,workUnitAsyncStorage:T})}async function R(e,t,r){x.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let o="/api/admin/commissions/route";o=o.replace(/\/index$/,"")||"/";let n=await x.prepare(e,t,{srcPage:o,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:P,params:w,nextConfig:C,parsedUrl:R,isDraftMode:_,prerenderManifest:T,routerServerContext:v,isOnDemandRevalidate:g,revalidateOnlyGenerated:A,resolvedPathname:U,clientReferenceManifest:S,serverActionsManifest:N}=n,O=(0,m.normalizeAppPath)(o),M=!!(T.dynamicRoutes[O]||T.routes[U]),I=async()=>((null==v?void 0:v.render404)?await v.render404(e,t,R,!1):t.end("This page could not be found"),null);if(M&&!_){let e=!!T.routes[U],t=T.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(C.experimental.adapterPath)return await I();throw new E.NoFallbackError}}let L=null;!M||x.isDev||_||(L=U,L="/index"===L?"/":L);let b=!0===x.isDev||!M,D=M&&!b;N&&S&&(0,l.setManifestsSingleton)({page:o,clientReferenceManifest:S,serverActionsManifest:N});let j=e.method||"GET",q=(0,i.getTracer)(),k=q.getActiveScopeSpan(),H={params:w,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:b,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,o,s)=>x.onRequestError(e,t,o,s,v)},sharedContext:{buildId:P}},$=new u.NodeNextRequest(e),X=new u.NodeNextResponse(t),z=c.NextRequestAdapter.fromNodeNextRequest($,(0,c.signalFromNodeResponse)(t));try{let n=async e=>x.handle(z,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=q.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=r.get("next.route");if(s){let t=`${j} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${o}`)}),l=!!(0,a.getRequestMeta)(e,"minimalMode"),m=async a=>{var i,m;let u=async({previousCacheEntry:s})=>{try{if(!l&&g&&A&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await n(a);e.fetchMetrics=H.renderOpts.fetchMetrics;let i=H.renderOpts.pendingWaitUntil;i&&r.waitUntil&&(r.waitUntil(i),i=void 0);let m=H.renderOpts.collectedTags;if(!M)return await (0,f.sendResponse)($,X,o,H.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,y.toNodeOutgoingHttpHeaders)(o.headers);m&&(t[h.NEXT_CACHE_TAGS_HEADER]=m),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,s=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:B.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:s}}}}catch(t){throw(null==s?void 0:s.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:o,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:g})},!1,v),t}},c=await x.handleResponse({req:e,nextConfig:C,cacheKey:L,routeKind:s.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:g,revalidateOnlyGenerated:A,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:l});if(!M)return null;if((null==c||null==(i=c.value)?void 0:i.kind)!==B.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(m=c.value)?void 0:m.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",g?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),_&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,y.fromNodeOutgoingHttpHeaders)(c.value.headers);return l&&M||d.delete(h.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,F.getCacheControlHeader)(c.cacheControl)),await (0,f.sendResponse)($,X,new Response(c.value.body,{headers:d,status:c.value.status||200})),null};k?await m(k):await q.withPropagatedContext(e.headers,()=>q.trace(d.BaseServerSpan.handleRequest,{spanName:`${j} ${o}`,kind:i.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},m))}catch(t){if(t instanceof E.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:g})},!1,v),M)throw t;return await (0,f.sendResponse)($,X,new Response(null,{status:500})),null}}e.s(["handler",()=>R,"patchFetch",()=>C,"routeModule",()=>x,"serverHooks",()=>v,"workAsyncStorage",()=>_,"workUnitAsyncStorage",()=>T]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__cfee538a._.js.map