module.exports=[57161,(e,t,r)=>{t.exports=e.x("@prisma/client-5551ed320f9fac8d",()=>require("@prisma/client-5551ed320f9fac8d"))},54969,e=>e.a(async(t,r)=>{try{let t=await e.y("pg-0af994d0a334f027");e.n(t),r()}catch(e){r(e)}},!0),93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},21060,e=>e.a(async(t,r)=>{try{var a=e.i(52613),s=t([a]);async function n(e,t){let r=new Date(t);r.setHours(0,0,0,0);let s=new Date(t);s.setHours(23,59,59,999);let[n,i,l]=await Promise.all([a.prisma.purchase.aggregate({where:{sellerId:e,status:"COMPLETED",createdAt:{gte:r,lte:s}},_sum:{sellerReceives:!0},_count:!0}),a.prisma.session.aggregate({where:{sellerId:e,createdAt:{gte:r,lte:s}},_count:!0}),a.prisma.$queryRaw`
      SELECT COUNT(DISTINCT p."buyerId") as count
      FROM "Purchase" p
      WHERE p."sellerId" = ${e}
        AND p.status = 'COMPLETED'
        AND p."createdAt" >= ${r}
        AND p."createdAt" <= ${s}
        AND NOT EXISTS (
          SELECT 1 FROM "Purchase" p2
          WHERE p2."buyerId" = p."buyerId"
            AND p2."sellerId" = ${e}
            AND p2.status = 'COMPLETED'
            AND p2."createdAt" < ${r}
        )
    `]),o=await a.prisma.session.count({where:{sellerId:e,status:{in:["COMPLETED","AWAITING_CONFIRMATION","PAID_OUT","RATED"]},completedAt:{gte:r,lte:s}}});await a.prisma.sellerDailyStats.upsert({where:{sellerId_date:{sellerId:e,date:r}},update:{revenue:n._sum.sellerReceives||0,purchases:n._count,sessions:i._count,completedSessions:o,newBuyers:Number(l[0]?.count||0)},create:{sellerId:e,date:r,revenue:n._sum.sellerReceives||0,purchases:n._count,sessions:i._count,completedSessions:o,newBuyers:Number(l[0]?.count||0)}})}async function i(e,t=90){let r=new Date,a=new Date(r);a.setDate(a.getDate()-t);for(let t=new Date(a);t<=r;t.setDate(t.getDate()+1))await n(e,new Date(t))}async function l(e){let t=await a.prisma.buyerAnalytics.findMany({where:{sellerId:e}}),r=Date.now();for(let e of t){let t=Math.floor((r-e.lastPurchaseAt.getTime())/864e5),s="low";t>90?s="high":t>30&&(s="medium"),e.churnRisk!==s&&await a.prisma.buyerAnalytics.update({where:{id:e.id},data:{churnRisk:s}})}}async function o(e){let t=await a.prisma.buyerAnalytics.findMany({where:{sellerId:e}}),r=t.length,s=t.filter(e=>e.totalPurchases>1).length,n=[];for(let e of t)if(e.totalPurchases>1){let t=Math.floor((e.lastPurchaseAt.getTime()-e.firstPurchaseAt.getTime())/864e5);n.push(t/(e.totalPurchases-1))}let i=n.length>0?n.reduce((e,t)=>e+t,0)/n.length:null,l=t.filter(e=>"high"===e.churnRisk).length,o=t.reduce((e,t)=>e+t.totalSessions,0),u=t.reduce((e,t)=>e+t.completedSessions,0),c=t.filter(e=>e.totalSessions>1).length,d=[],p=new Date;for(let e=5;e>=0;e--){let r=new Date(p.getFullYear(),p.getMonth()-e,1),a=new Date(p.getFullYear(),p.getMonth()-e+1,0),s=t.filter(e=>e.firstPurchaseAt>=r&&e.firstPurchaseAt<=a),n=new Date(p);n.setDate(n.getDate()-30);let i=s.filter(e=>e.lastPurchaseAt>=n).length;d.push({month:r.toISOString().slice(0,7),totalBuyers:s.length,stillActive:i,retention:s.length>0?i/s.length:0})}let h=t.map(e=>e.lifetimeValue).sort((e,t)=>e-t),f=h.length>0?h.reduce((e,t)=>e+t,0)/h.length:0,y=h.length>0?h[Math.floor(h.length/2)]:0,g=Math.floor(.9*h.length),m=h.length>0&&h[g]||0;return{repeatBuyerRate:r>0?s/r:0,averageRepurchaseTimeDays:i,buyerChurnRate:r>0?l/r:0,sessionCompletionRate:o>0?u/o:0,rebookingRate:r>0?c/r:0,cohorts:d,buyerLifetimeValue:{average:f,median:y,top10Percent:m}}}async function u(e,t="daily",r=30){let s=new Date,n=new Date;n.setDate(n.getDate()-r);let i=await a.prisma.sellerDailyStats.findMany({where:{sellerId:e,date:{gte:n,lte:s}},orderBy:{date:"asc"}}),l=i.reduce((e,t)=>e+t.revenue,0),o=new Date(n);o.setDate(o.getDate()-1);let c=new Date(o);c.setDate(c.getDate()-r);let d=(await a.prisma.sellerDailyStats.findMany({where:{sellerId:e,date:{gte:c,lte:o}}})).reduce((e,t)=>e+t.revenue,0),p=[];if("daily"===t)for(let e of i)p.push({date:e.date.toISOString().slice(0,10),revenue:e.revenue,purchases:e.purchases,sessions:e.sessions});else if("weekly"===t){let e=new Map;for(let t of i){let r=(function(e){let t=new Date(e),r=t.getDay(),a=t.getDate()-r;return t.setDate(a),t.setHours(0,0,0,0),t})(t.date).toISOString().slice(0,10);e.has(r)||e.set(r,{date:r,revenue:0,purchases:0,sessions:0});let a=e.get(r);a.revenue+=t.revenue,a.purchases+=t.purchases,a.sessions+=t.sessions}p.push(...Array.from(e.values()))}else{let e=new Map;for(let t of i){let r=t.date.toISOString().slice(0,7);e.has(r)||e.set(r,{date:r,revenue:0,purchases:0,sessions:0});let a=e.get(r);a.revenue+=t.revenue,a.purchases+=t.purchases,a.sessions+=t.sessions}p.push(...Array.from(e.values()))}return{totalRevenue:l,periodComparison:{current:l,previous:d,changePercent:d>0?(l-d)/d*100:0},chartData:p}}async function c(e,t=10,r="all"){let s;"year"===r?(s=new Date).setFullYear(s.getFullYear()-1):"month"===r&&(s=new Date).setMonth(s.getMonth()-1);let n=await a.prisma.buyerAnalytics.findMany({where:{sellerId:e,...s?{lastPurchaseAt:{gte:s}}:{}},orderBy:{totalSpent:"desc"},take:t}),i=n.map(e=>e.buyerId),l=await a.prisma.user.findMany({where:{id:{in:i}},select:{id:!0,name:!0,avatar:!0}}),o=new Map(l.map(e=>[e.id,e]));return n.map(e=>{let t=o.get(e.buyerId);return{buyerId:e.buyerId,buyerName:t?.name||null,buyerAvatar:t?.avatar||null,totalSpent:e.totalSpent,totalSessions:e.totalSessions,lastPurchaseAt:e.lastPurchaseAt}})}async function d(e){let t=await a.prisma.session.findMany({where:{sellerId:e,scheduledAt:{not:null}},select:{scheduledAt:!0}}),r=new Map,s=new Map,n=new Map;for(let e of t){if(!e.scheduledAt)continue;let t=e.scheduledAt.getHours(),a=e.scheduledAt.getDay();r.set(t,(r.get(t)||0)+1),s.set(a,(s.get(a)||0)+1),n.set(`${a}-${t}`,(n.get(`${a}-${t}`)||0)+1)}let i=Array.from(r.entries()).map(([e,t])=>({hour:e,count:t})).sort((e,t)=>t.count-e.count),l=Array.from(s.entries()).map(([e,t])=>({day:e,count:t})).sort((e,t)=>t.count-e.count),o=Array.from(n.entries()).map(([e,t])=>{let[r,a]=e.split("-").map(Number);return{day:r,hour:a,count:t}});return{peakHours:i,peakDays:l,heatmap:o}}async function p(e,t={}){let{sort:r="totalSpent",churnRisk:s,minSpent:n,limit:i=20,cursor:l}=t,o=await a.prisma.buyerAnalytics.findMany({where:{sellerId:e,...s?{churnRisk:s}:{},...n?{totalSpent:{gte:n}}:{},...l?{id:{gt:l}}:{}},orderBy:{[r]:"desc"},take:i+1}),u=o.length>i;u&&o.pop();let c=o.map(e=>e.buyerId),d=await a.prisma.user.findMany({where:{id:{in:c}},select:{id:!0,name:!0,avatar:!0}}),h=new Map(d.map(e=>[e.id,e]));return{buyers:o.map(e=>{let t=h.get(e.buyerId);return{buyerId:e.buyerId,buyerName:t?.name||null,buyerAvatar:t?.avatar||null,firstPurchaseAt:e.firstPurchaseAt,lastPurchaseAt:e.lastPurchaseAt,totalPurchases:e.totalPurchases,totalSpent:e.totalSpent,totalSessions:e.totalSessions,completedSessions:e.completedSessions,lifetimeValue:e.lifetimeValue,churnRisk:e.churnRisk}}),nextCursor:u?o[o.length-1].id:null}}[a]=s.then?(await s)():s,e.s(["assessChurnRiskForSeller",()=>l,"backfillDailyStats",()=>i,"computeRetentionMetrics",()=>o,"fetchBuyerInsights",()=>p,"fetchPeakTimes",()=>d,"fetchRevenueAnalytics",()=>u,"fetchTopBuyers",()=>c]),r()}catch(e){r(e)}},!1),85899,e=>e.a(async(t,r)=>{try{var a=e.i(39660),s=e.i(52613),n=e.i(83974),i=e.i(21060),l=t([s,i]);async function o(e){try{let{userId:t}=await n.whopsdk.verifyUserToken(e.headers),r=await s.prisma.user.findUnique({where:{whopUserId:t},include:{sellerProfile:!0}});if(!r)return a.NextResponse.json({error:"User not found"},{status:404});if(!r.sellerProfile)return a.NextResponse.json({error:"Seller profile not found"},{status:404});await (0,i.assessChurnRiskForSeller)(r.id);let l=await (0,i.computeRetentionMetrics)(r.id);return a.NextResponse.json(l)}catch(e){return console.error("Error fetching retention metrics:",e),a.NextResponse.json({error:"Failed to fetch retention metrics"},{status:500})}}[s,i]=l.then?(await l)():l,e.s(["GET",()=>o]),r()}catch(e){r(e)}},!1),861,e=>e.a(async(t,r)=>{try{var a=e.i(13348),s=e.i(41275),n=e.i(34648),i=e.i(75319),l=e.i(32964),o=e.i(43172),u=e.i(49870),c=e.i(70891),d=e.i(98634),p=e.i(23259),h=e.i(39185),f=e.i(34505),y=e.i(19549),g=e.i(52060),m=e.i(84024),w=e.i(93695);e.i(42630);var R=e.i(4945),v=e.i(85899),A=t([v]);[v]=A.then?(await A)():A;let E=new a.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/sellers/analytics/retention/route",pathname:"/api/sellers/analytics/retention",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/waliet/app/api/sellers/analytics/retention/route.ts",nextConfigOutput:"",userland:v}),{workAsyncStorage:S,workUnitAsyncStorage:b,serverHooks:P}=E;function x(){return(0,n.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:b})}async function D(e,t,r){E.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/sellers/analytics/retention/route";a=a.replace(/\/index$/,"")||"/";let n=await E.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:v,params:A,nextConfig:x,parsedUrl:D,isDraftMode:S,prerenderManifest:b,routerServerContext:P,isOnDemandRevalidate:C,revalidateOnlyGenerated:T,resolvedPathname:M,clientReferenceManifest:N,serverActionsManifest:I}=n,O=(0,u.normalizeAppPath)(a),k=!!(b.dynamicRoutes[O]||b.routes[M]),_=async()=>((null==P?void 0:P.render404)?await P.render404(e,t,D,!1):t.end("This page could not be found"),null);if(k&&!S){let e=!!b.routes[M],t=b.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await _();throw new w.NoFallbackError}}let q=null;!k||E.isDev||S||(q=M,q="/index"===q?"/":q);let H=!0===E.isDev||!k,j=k&&!H;I&&N&&(0,o.setManifestsSingleton)({page:a,clientReferenceManifest:N,serverActionsManifest:I});let U=e.method||"GET",$=(0,l.getTracer)(),F=$.getActiveScopeSpan(),B={params:A,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,s)=>E.onRequestError(e,t,a,s,P)},sharedContext:{buildId:v}},L=new c.NodeNextRequest(e),K=new c.NodeNextResponse(t),V=d.NextRequestAdapter.fromNodeNextRequest(L,(0,d.signalFromNodeResponse)(t));try{let n=async e=>E.handle(V,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=$.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=r.get("next.route");if(s){let t=`${U} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${a}`)}),o=!!(0,i.getRequestMeta)(e,"minimalMode"),u=async i=>{var l,u;let c=async({previousCacheEntry:s})=>{try{if(!o&&C&&T&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await n(i);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let u=B.renderOpts.collectedTags;if(!k)return await (0,f.sendResponse)(L,K,a,B.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,y.toNodeOutgoingHttpHeaders)(a.headers);u&&(t[m.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,s=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:s}}}}catch(t){throw(null==s?void 0:s.isStale)&&await E.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:C})},!1,P),t}},d=await E.handleResponse({req:e,nextConfig:x,cacheKey:q,routeKind:s.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:T,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:o});if(!k)return null;if((null==d||null==(l=d.value)?void 0:l.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(u=d.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",C?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,y.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&k||p.delete(m.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,g.getCacheControlHeader)(d.cacheControl)),await (0,f.sendResponse)(L,K,new Response(d.value.body,{headers:p,status:d.value.status||200})),null};F?await u(F):await $.withPropagatedContext(e.headers,()=>$.trace(p.BaseServerSpan.handleRequest,{spanName:`${U} ${a}`,kind:l.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},u))}catch(t){if(t instanceof w.NoFallbackError||await E.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:C})},!1,P),k)throw t;return await (0,f.sendResponse)(L,K,new Response(null,{status:500})),null}}e.s(["handler",()=>D,"patchFetch",()=>x,"routeModule",()=>E,"serverHooks",()=>P,"workAsyncStorage",()=>S,"workUnitAsyncStorage",()=>b]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__f0c01d48._.js.map