{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 48, "column": 0}, "map": {"version":3,"sources":["file:///Users/ivelinivanov/waliet/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\nimport { PrismaPg } from \"@prisma/adapter-pg\";\nimport { Pool } from \"pg\";\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\nfunction createPrismaClient() {\n  const pool = new Pool({ connectionString: process.env.DATABASE_URL });\n  const adapter = new PrismaPg(pool);\n  return new PrismaClient({ adapter });\n}\n\nexport const prisma = globalForPrisma.prisma ?? createPrismaClient();\n\nif (process.env.NODE_ENV !== \"production\") {\n  globalForPrisma.prisma = prisma;\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;;AAEA,MAAM,kBAAkB;AAIxB,SAAS;IACP,MAAM,OAAO,IAAI,+JAAI,CAAC;QAAE,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAAC;IACnE,MAAM,UAAU,IAAI,mLAAQ,CAAC;IAC7B,OAAO,IAAI,gNAAY,CAAC;QAAE;IAAQ;AACpC;AAEO,MAAM,SAAS,gBAAgB,MAAM,IAAI;AAEhD,wCAA2C;IACzC,gBAAgB,MAAM,GAAG;AAC3B"}},
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/ivelinivanov/waliet/lib/whop-sdk.ts"],"sourcesContent":["import { Whop } from \"@whop/sdk\";\n\nif (!process.env.NEXT_PUBLIC_WHOP_APP_ID) {\n  throw new Error(\"NEXT_PUBLIC_WHOP_APP_ID is not set\");\n}\n\nif (!process.env.WHOP_API_KEY) {\n  throw new Error(\"WHOP_API_KEY is not set\");\n}\n\nexport const whopsdk = new Whop({\n  appID: process.env.NEXT_PUBLIC_WHOP_APP_ID,\n  apiKey: process.env.WHOP_API_KEY,\n  webhookKey: btoa(process.env.WHOP_WEBHOOK_SECRET || \"\"),\n});\n\n// Platform company ID for receiving payments and sending payouts\nexport const PLATFORM_COMPANY_ID = process.env.PLATFORM_COMPANY_ID;\n\n/**\n * Transfer funds from platform account to a user (seller payout)\n * Uses Whop's transfers API to move money from the platform's balance\n * to a seller's Whop wallet\n *\n * Note: The actual Whop SDK types may differ. This function uses any types\n * and should be updated when the actual API structure is confirmed.\n */\nexport async function createPayoutTransfer(params: {\n  recipientUserId: string;\n  amountCents: number;\n  description: string;\n  idempotencyKey: string;\n  metadata?: Record<string, string>;\n}): Promise<{ transferId: string; status: string }> {\n  if (!PLATFORM_COMPANY_ID) {\n    throw new Error(\"PLATFORM_COMPANY_ID is not set\");\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const response = await (whopsdk.transfers as any).create({\n    origin: PLATFORM_COMPANY_ID,\n    destination: params.recipientUserId,\n    amount_cents: params.amountCents,\n    currency: \"usd\",\n    description: params.description,\n    idempotency_key: params.idempotencyKey,\n    metadata: params.metadata,\n  });\n\n  return {\n    transferId: response.id,\n    status: response.status || \"pending\",\n  };\n}\n\n/**\n * Check the status of a transfer\n */\nexport async function getTransferStatus(\n  transferId: string\n): Promise<{ status: string; failureReason?: string }> {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const response = await (whopsdk.transfers as any).retrieve(transferId);\n\n  return {\n    status: response.status || \"unknown\",\n    failureReason:\n      response.status === \"failed\" ? response.failure_message : undefined,\n  };\n}\n\n/**\n * Create a checkout configuration for purchasing hours\n * Uses Whop's checkoutConfigurations API which creates a plan and returns\n * a checkout config that can be used with iframeSdk.inAppPurchase()\n */\nexport async function createCheckoutConfig(params: {\n  name: string;\n  amountCents: number;\n  currency: \"usd\";\n  metadata: Record<string, string>;\n  redirectUrl?: string;\n}): Promise<{ id: string; planId: string; purchaseUrl: string }> {\n  if (!PLATFORM_COMPANY_ID) {\n    throw new Error(\"PLATFORM_COMPANY_ID is not set\");\n  }\n\n  // Create checkout configuration with an inline plan\n  // Note: Whop's initial_price expects dollars, not cents\n  const response = await whopsdk.checkoutConfigurations.create({\n    plan: {\n      company_id: PLATFORM_COMPANY_ID,\n      currency: params.currency,\n      initial_price: params.amountCents / 100,\n      plan_type: \"one_time\",\n      title: params.name,\n      visibility: \"hidden\",\n      product: {\n        external_identifier: `waliet_hours_${Date.now()}`,\n        title: params.name,\n        business_type: \"coaching\",\n      },\n    },\n    metadata: params.metadata,\n    redirect_url: params.redirectUrl,\n  });\n\n  if (!response || !response.plan) {\n    throw new Error(\"Failed to create checkout configuration\");\n  }\n\n  return {\n    id: response.id,\n    planId: response.plan.id,\n    purchaseUrl: response.purchase_url,\n  };\n}\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;AAAA;;AAEA;;AAIA,IAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,EAAE;IAC7B,MAAM,IAAI,MAAM;AAClB;AAEO,MAAM,UAAU,IAAI,4JAAI,CAAC;IAC9B,KAAK;IACL,QAAQ,QAAQ,GAAG,CAAC,YAAY;IAChC,YAAY,KAAK,QAAQ,GAAG,CAAC,mBAAmB,IAAI;AACtD;AAGO,MAAM,sBAAsB,QAAQ,GAAG,CAAC,mBAAmB;AAU3D,eAAe,qBAAqB,MAM1C;IACC,IAAI,CAAC,qBAAqB;QACxB,MAAM,IAAI,MAAM;IAClB;IAEA,8DAA8D;IAC9D,MAAM,WAAW,MAAM,AAAC,QAAQ,SAAS,CAAS,MAAM,CAAC;QACvD,QAAQ;QACR,aAAa,OAAO,eAAe;QACnC,cAAc,OAAO,WAAW;QAChC,UAAU;QACV,aAAa,OAAO,WAAW;QAC/B,iBAAiB,OAAO,cAAc;QACtC,UAAU,OAAO,QAAQ;IAC3B;IAEA,OAAO;QACL,YAAY,SAAS,EAAE;QACvB,QAAQ,SAAS,MAAM,IAAI;IAC7B;AACF;AAKO,eAAe,kBACpB,UAAkB;IAElB,8DAA8D;IAC9D,MAAM,WAAW,MAAM,AAAC,QAAQ,SAAS,CAAS,QAAQ,CAAC;IAE3D,OAAO;QACL,QAAQ,SAAS,MAAM,IAAI;QAC3B,eACE,SAAS,MAAM,KAAK,WAAW,SAAS,eAAe,GAAG;IAC9D;AACF;AAOO,eAAe,qBAAqB,MAM1C;IACC,IAAI,CAAC,qBAAqB;QACxB,MAAM,IAAI,MAAM;IAClB;IAEA,oDAAoD;IACpD,wDAAwD;IACxD,MAAM,WAAW,MAAM,QAAQ,sBAAsB,CAAC,MAAM,CAAC;QAC3D,MAAM;YACJ,YAAY;YACZ,UAAU,OAAO,QAAQ;YACzB,eAAe,OAAO,WAAW,GAAG;YACpC,WAAW;YACX,OAAO,OAAO,IAAI;YAClB,YAAY;YACZ,SAAS;gBACP,qBAAqB,CAAC,aAAa,EAAE,KAAK,GAAG,IAAI;gBACjD,OAAO,OAAO,IAAI;gBAClB,eAAe;YACjB;QACF;QACA,UAAU,OAAO,QAAQ;QACzB,cAAc,OAAO,WAAW;IAClC;IAEA,IAAI,CAAC,YAAY,CAAC,SAAS,IAAI,EAAE;QAC/B,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO;QACL,IAAI,SAAS,EAAE;QACf,QAAQ,SAAS,IAAI,CAAC,EAAE;QACxB,aAAa,SAAS,YAAY;IACpC;AACF"}},
    {"offset": {"line": 171, "column": 0}, "map": {"version":3,"sources":["file:///Users/ivelinivanov/waliet/lib/validations.ts"],"sourcesContent":["import { z } from \"zod\";\n\n// ============================================\n// SELLER VALIDATIONS\n// ============================================\n\nexport const createSellerSchema = z.object({\n  hourlyRate: z.number().min(1).max(10000), // $1 - $10,000 per hour\n  bio: z.string().max(500).optional(),\n  tagline: z.string().max(100).optional(),\n  timezone: z.string().optional(),\n});\n\nexport const updateSellerRateSchema = z.object({\n  hourlyRate: z.number().min(1).max(10000),\n});\n\nexport const sellerQuerySchema = z.object({\n  experienceId: z.string().optional(),\n  companyId: z.string().optional(),\n  minRating: z.coerce.number().min(1).max(5).optional(),\n  maxRate: z.coerce.number().optional(),\n  cursor: z.string().optional(),\n  limit: z.coerce.number().min(1).max(50).default(20),\n  sort: z\n    .enum([\"rating\", \"sessions\", \"rate_asc\", \"rate_desc\", \"newest\"])\n    .default(\"rating\"),\n});\n\n// ============================================\n// PURCHASE VALIDATIONS\n// ============================================\n\nexport const createPurchaseSchema = z.object({\n  sellerId: z.string(),\n  units: z.number().int().min(1).max(20), // 30-min units, max 10 hours\n  experienceId: z.string().optional(),\n  companyId: z.string().optional(),\n});\n\n// ============================================\n// SESSION VALIDATIONS\n// ============================================\n\nexport const createSessionSchema = z.object({\n  sellerId: z.string(),\n  units: z.number().int().min(1).max(4), // 30-min to 2 hours per session\n  topic: z.string().min(20).max(500),\n  proposedTimes: z.array(z.string().datetime()).min(1).max(5),\n  timezone: z.string(),\n});\n\nexport const acceptSessionSchema = z.object({\n  scheduledAt: z.string().datetime(),\n});\n\nexport const endSessionSchema = z.object({\n  actualMinutes: z.number().int().min(1),\n});\n\nexport const cancelSessionSchema = z.object({\n  reason: z.string().max(500).optional(),\n});\n\nexport const sessionQuerySchema = z.object({\n  role: z.enum([\"buyer\", \"seller\"]).optional(),\n  status: z.string().optional(),\n  cursor: z.string().optional(),\n  limit: z.coerce.number().min(1).max(50).default(20),\n});\n\nexport const disputeSessionSchema = z.object({\n  reason: z.string().min(20).max(1000),\n});\n\nexport const resolveDisputeSchema = z.object({\n  action: z.enum([\"approve\", \"deny\"]),\n  amountApproved: z.number().int().min(0).optional(),\n  reviewNotes: z.string().max(1000).optional(),\n});\n\n// ============================================\n// REVIEW VALIDATIONS\n// ============================================\n\nexport const createReviewSchema = z.object({\n  rating: z.number().int().min(1).max(5),\n  text: z.string().max(1000).optional(),\n  isAnonymous: z.boolean().optional(),\n});\n\n// ============================================\n// COMMUNITY CONFIG VALIDATIONS\n// ============================================\n\nexport const updateCommunityConfigSchema = z.object({\n  communityFeeBps: z.number().int().min(0).max(5000).optional(), // 0-50%\n  minSellerRating: z.number().min(1).max(5).optional().nullable(),\n  requireApproval: z.boolean().optional(),\n});\n\n// ============================================\n// REFUND VALIDATIONS\n// ============================================\n\nexport const createRefundRequestSchema = z.object({\n  purchaseId: z.string().optional(),\n  sessionId: z.string().optional(),\n  reason: z.string().min(10).max(1000),\n  amountRequested: z.number().int().min(1),\n});\n\n// ============================================\n// TYPE EXPORTS\n// ============================================\n\nexport type CreateSellerInput = z.infer<typeof createSellerSchema>;\nexport type UpdateSellerRateInput = z.infer<typeof updateSellerRateSchema>;\nexport type SellerQueryInput = z.infer<typeof sellerQuerySchema>;\nexport type CreatePurchaseInput = z.infer<typeof createPurchaseSchema>;\nexport type CreateSessionInput = z.infer<typeof createSessionSchema>;\nexport type AcceptSessionInput = z.infer<typeof acceptSessionSchema>;\nexport type EndSessionInput = z.infer<typeof endSessionSchema>;\nexport type CancelSessionInput = z.infer<typeof cancelSessionSchema>;\nexport type CreateReviewInput = z.infer<typeof createReviewSchema>;\nexport type UpdateCommunityConfigInput = z.infer<typeof updateCommunityConfigSchema>;\nexport type CreateRefundRequestInput = z.infer<typeof createRefundRequestSchema>;\nexport type SessionQueryInput = z.infer<typeof sessionQuerySchema>;\nexport type DisputeSessionInput = z.infer<typeof disputeSessionSchema>;\nexport type ResolveDisputeInput = z.infer<typeof resolveDisputeSchema>;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 291, "column": 0}, "map": {"version":3,"sources":["file:///Users/ivelinivanov/waliet/lib/auth.ts"],"sourcesContent":["import { headers, cookies } from \"next/headers\";\nimport { whopsdk } from \"./whop-sdk\";\nimport { prisma } from \"./prisma\";\n\nexport interface WhopUser {\n  userId: string;\n  name: string | null;\n  username: string;\n  email?: string;\n  profilePicUrl?: string;\n}\n\n/**\n * Get the current Whop user from headers\n * Returns null if not authenticated\n * In development, can use DEV_WHOP_USER_ID env var to bypass auth\n */\nexport async function getWhopUser(): Promise<WhopUser | null> {\n  try {\n    const cookieStore = await cookies();\n\n    // Check if user explicitly logged out - skip ALL Whop auth\n    const loggedOut = cookieStore.get(\"waliet-logged-out\")?.value === \"true\";\n    if (loggedOut) {\n      return null;\n    }\n\n    let userId: string | null = null;\n\n    // In development, allow bypassing auth with DEV_WHOP_USER_ID\n    if (process.env.NODE_ENV === \"development\" && process.env.DEV_WHOP_USER_ID) {\n      userId = process.env.DEV_WHOP_USER_ID;\n    } else {\n      // Normal auth flow - verify token from headers (middleware handles dev token)\n      const headersList = await headers();\n      const whopToken = headersList.get(\"x-whop-user-token\");\n\n      console.log(\"[Auth] Token present:\", !!whopToken);\n\n      if (!whopToken) {\n        console.error(\"[Auth] No Whop token found in headers\");\n        return null;\n      }\n\n      try {\n        const result = await whopsdk.verifyUserToken(headersList);\n        userId = result.userId;\n        console.log(\"[Auth] Verified userId:\", userId);\n      } catch (err) {\n        console.error(\"[Auth] Token verification failed:\", err);\n        return null;\n      }\n    }\n\n    if (!userId) return null;\n\n    // Fetch full user data from Whop\n    const user = await whopsdk.users.retrieve(userId);\n\n    // Cast to extended type for additional properties not in SDK types\n    type ExtendedWhopUser = { email?: string };\n    const extendedUser = user as unknown as ExtendedWhopUser;\n\n    return {\n      userId,\n      name: user.name,\n      username: user.username,\n      email: extendedUser.email,\n      profilePicUrl: user.profile_picture?.url || undefined,\n    };\n  } catch {\n    return null;\n  }\n}\n\n/**\n * Sync Whop user to database\n * Creates user if doesn't exist, updates if profile changed\n * Uses upsert to handle race conditions\n */\nexport async function syncUserToDatabase(whopUser: WhopUser) {\n  return prisma.user.upsert({\n    where: { whopUserId: whopUser.userId },\n    update: {\n      name: whopUser.name,\n      avatar: whopUser.profilePicUrl || null,\n      email: whopUser.email || undefined,\n    },\n    create: {\n      whopUserId: whopUser.userId,\n      name: whopUser.name,\n      avatar: whopUser.profilePicUrl || null,\n      email: whopUser.email || null,\n    },\n    include: { sellerProfile: true },\n  });\n}\n\n/**\n * Get authenticated user with synced database profile\n * Use this in server components that need auth\n */\nexport async function getAuthenticatedUser() {\n  const whopUser = await getWhopUser();\n\n  if (!whopUser) return null;\n\n  const user = await syncUserToDatabase(whopUser);\n\n  return {\n    ...whopUser,\n    user,\n  };\n}\n\n/**\n * Check if user has access to an experience\n * In development with DEV_WHOP_USER_ID, always returns true\n */\nexport async function checkExperienceAccess(\n  experienceId: string,\n  userId: string\n): Promise<boolean> {\n  // In development with dev user, bypass access check\n  if (process.env.NODE_ENV === \"development\" && process.env.DEV_WHOP_USER_ID) {\n    return true;\n  }\n\n  try {\n    const access = await whopsdk.users.checkAccess(experienceId, { id: userId });\n    return access.has_access;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Check if user is an admin of a company\n */\nexport async function checkCompanyAdmin(\n  companyId: string,\n  userId: string\n): Promise<boolean> {\n  try {\n    const access = await whopsdk.users.checkAccess(companyId, { id: userId });\n    return access.access_level === \"admin\";\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Get or create a user from Whop user ID\n * Used in API routes where we have the userId from verifyUserToken\n */\nexport async function getOrCreateUser(whopUserId: string) {\n  const existingUser = await prisma.user.findUnique({\n    where: { whopUserId },\n    include: { sellerProfile: true },\n  });\n\n  if (existingUser) {\n    return existingUser;\n  }\n\n  // Fetch user details from Whop\n  const whopUser = await whopsdk.users.retrieve(whopUserId);\n  type ExtendedWhopUser = { email?: string };\n  const extendedUser = whopUser as unknown as ExtendedWhopUser;\n\n  const newUser = await prisma.user.create({\n    data: {\n      whopUserId,\n      email: extendedUser.email ?? null,\n      name: whopUser.name,\n      avatar: whopUser.profile_picture?.url ?? null,\n    },\n    include: { sellerProfile: true },\n  });\n\n  return newUser;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 449, "column": 0}, "map": {"version":3,"sources":["file:///Users/ivelinivanov/waliet/app/api/sellers/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/prisma\";\nimport { whopsdk } from \"@/lib/whop-sdk\";\nimport { sellerQuerySchema, createSellerSchema } from \"@/lib/validations\";\nimport { getOrCreateUser } from \"@/lib/auth\";\n\nexport async function GET(request: NextRequest) {\n  try {\n    await whopsdk.verifyUserToken(request.headers);\n\n    const { searchParams } = new URL(request.url);\n    const query = sellerQuerySchema.parse(Object.fromEntries(searchParams));\n\n    const orderBy = {\n      rating: { averageRating: \"desc\" as const },\n      sessions: { totalSessionsCompleted: \"desc\" as const },\n      rate_asc: { hourlyRate: \"asc\" as const },\n      rate_desc: { hourlyRate: \"desc\" as const },\n      newest: { createdAt: \"desc\" as const },\n    }[query.sort];\n\n    const sellers = await prisma.sellerProfile.findMany({\n      where: {\n        isActive: true,\n        ...(query.minRating && { averageRating: { gte: query.minRating } }),\n        ...(query.maxRate && { hourlyRate: { lte: query.maxRate } }),\n      },\n      include: {\n        user: {\n          select: {\n            id: true,\n            name: true,\n            avatar: true,\n          },\n        },\n      },\n      orderBy,\n      take: query.limit + 1,\n      ...(query.cursor && { cursor: { id: query.cursor }, skip: 1 }),\n    });\n\n    const hasMore = sellers.length > query.limit;\n    const results = hasMore ? sellers.slice(0, -1) : sellers;\n\n    // Transform to match SellerData format\n    const transformedSellers = results.map((seller) => ({\n      id: seller.id,\n      userId: seller.user.id,\n      hourlyRate: seller.hourlyRate,\n      bio: seller.bio,\n      tagline: seller.tagline,\n      averageRating: seller.averageRating,\n      totalSessionsCompleted: seller.totalSessionsCompleted,\n      isVerified: seller.isVerified,\n      hasSellerProfile: true,\n      user: seller.user,\n    }));\n\n    return NextResponse.json({\n      sellers: transformedSellers,\n      nextCursor: hasMore ? results[results.length - 1].id : null,\n    });\n  } catch (error) {\n    console.error(\"Error fetching sellers:\", error);\n    return NextResponse.json(\n      { error: \"Failed to fetch sellers\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const { userId: whopUserId } = await whopsdk.verifyUserToken(\n      request.headers\n    );\n\n    const body = await request.json();\n    const { hourlyRate, bio, tagline, timezone } = createSellerSchema.parse(body);\n\n    // Get or create user\n    const user = await getOrCreateUser(whopUserId);\n    if (!user) {\n      return NextResponse.json(\n        { error: \"Failed to get or create user\" },\n        { status: 500 }\n      );\n    }\n\n    // Check if already has seller profile\n    const existing = await prisma.sellerProfile.findUnique({\n      where: { userId: user.id },\n    });\n\n    if (existing) {\n      return NextResponse.json(\n        { error: \"Seller profile already exists\" },\n        { status: 400 }\n      );\n    }\n\n    // Create seller profile\n    const sellerProfile = await prisma.sellerProfile.create({\n      data: {\n        userId: user.id,\n        hourlyRate: Math.round(hourlyRate * 100), // Convert to cents\n        bio,\n        tagline,\n        timezone: timezone || \"America/New_York\",\n        rateHistory: {\n          create: {\n            previousRate: 0,\n            newRate: Math.round(hourlyRate * 100),\n          },\n        },\n      },\n      include: {\n        user: {\n          select: {\n            id: true,\n            name: true,\n            avatar: true,\n          },\n        },\n      },\n    });\n\n    return NextResponse.json({ sellerProfile }, { status: 201 });\n  } catch (error) {\n    console.error(\"Error creating seller profile:\", error);\n    return NextResponse.json(\n      { error: \"Failed to create seller profile\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}