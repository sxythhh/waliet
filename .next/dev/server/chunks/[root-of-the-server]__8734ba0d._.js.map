{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 48, "column": 0}, "map": {"version":3,"sources":["file:///Users/ivelinivanov/waliet/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\nimport { PrismaPg } from \"@prisma/adapter-pg\";\nimport { Pool } from \"pg\";\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\nfunction createPrismaClient() {\n  const pool = new Pool({ connectionString: process.env.DATABASE_URL });\n  const adapter = new PrismaPg(pool);\n  return new PrismaClient({ adapter });\n}\n\nexport const prisma = globalForPrisma.prisma ?? createPrismaClient();\n\nif (process.env.NODE_ENV !== \"production\") {\n  globalForPrisma.prisma = prisma;\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;;AAEA,MAAM,kBAAkB;AAIxB,SAAS;IACP,MAAM,OAAO,IAAI,+JAAI,CAAC;QAAE,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAAC;IACnE,MAAM,UAAU,IAAI,mLAAQ,CAAC;IAC7B,OAAO,IAAI,gNAAY,CAAC;QAAE;IAAQ;AACpC;AAEO,MAAM,SAAS,gBAAgB,MAAM,IAAI;AAEhD,wCAA2C;IACzC,gBAAgB,MAAM,GAAG;AAC3B"}},
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/ivelinivanov/waliet/lib/whop-sdk.ts"],"sourcesContent":["import { Whop } from \"@whop/sdk\";\n\nif (!process.env.NEXT_PUBLIC_WHOP_APP_ID) {\n  throw new Error(\"NEXT_PUBLIC_WHOP_APP_ID is not set\");\n}\n\nif (!process.env.WHOP_API_KEY) {\n  throw new Error(\"WHOP_API_KEY is not set\");\n}\n\nexport const whopsdk = new Whop({\n  appID: process.env.NEXT_PUBLIC_WHOP_APP_ID,\n  apiKey: process.env.WHOP_API_KEY,\n  webhookKey: btoa(process.env.WHOP_WEBHOOK_SECRET || \"\"),\n});\n\n// Platform company ID for receiving payments and sending payouts\nexport const PLATFORM_COMPANY_ID = process.env.PLATFORM_COMPANY_ID;\n\n/**\n * Transfer funds from platform account to a user (seller payout)\n * Uses Whop's transfers API to move money from the platform's balance\n * to a seller's Whop wallet\n *\n * Note: The actual Whop SDK types may differ. This function uses any types\n * and should be updated when the actual API structure is confirmed.\n */\nexport async function createPayoutTransfer(params: {\n  recipientUserId: string;\n  amountCents: number;\n  description: string;\n  idempotencyKey: string;\n  metadata?: Record<string, string>;\n}): Promise<{ transferId: string; status: string }> {\n  if (!PLATFORM_COMPANY_ID) {\n    throw new Error(\"PLATFORM_COMPANY_ID is not set\");\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const response = await (whopsdk.transfers as any).create({\n    origin: PLATFORM_COMPANY_ID,\n    destination: params.recipientUserId,\n    amount_cents: params.amountCents,\n    currency: \"usd\",\n    description: params.description,\n    idempotency_key: params.idempotencyKey,\n    metadata: params.metadata,\n  });\n\n  return {\n    transferId: response.id,\n    status: response.status || \"pending\",\n  };\n}\n\n/**\n * Check the status of a transfer\n */\nexport async function getTransferStatus(\n  transferId: string\n): Promise<{ status: string; failureReason?: string }> {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const response = await (whopsdk.transfers as any).retrieve(transferId);\n\n  return {\n    status: response.status || \"unknown\",\n    failureReason:\n      response.status === \"failed\" ? response.failure_message : undefined,\n  };\n}\n\n/**\n * Create a checkout configuration for purchasing hours\n * Uses Whop's checkoutConfigurations API which creates a plan and returns\n * a checkout config that can be used with iframeSdk.inAppPurchase()\n */\nexport async function createCheckoutConfig(params: {\n  name: string;\n  amountCents: number;\n  currency: \"usd\";\n  metadata: Record<string, string>;\n  redirectUrl?: string;\n}): Promise<{ id: string; planId: string; purchaseUrl: string }> {\n  if (!PLATFORM_COMPANY_ID) {\n    throw new Error(\"PLATFORM_COMPANY_ID is not set\");\n  }\n\n  // Create checkout configuration with an inline plan\n  // Note: Whop's initial_price expects dollars, not cents\n  const response = await whopsdk.checkoutConfigurations.create({\n    plan: {\n      company_id: PLATFORM_COMPANY_ID,\n      currency: params.currency,\n      initial_price: params.amountCents / 100,\n      plan_type: \"one_time\",\n      title: params.name,\n      visibility: \"hidden\",\n      product: {\n        external_identifier: `waliet_hours_${Date.now()}`,\n        title: params.name,\n        business_type: \"coaching\",\n      },\n    },\n    metadata: params.metadata,\n    redirect_url: params.redirectUrl,\n  });\n\n  if (!response || !response.plan) {\n    throw new Error(\"Failed to create checkout configuration\");\n  }\n\n  return {\n    id: response.id,\n    planId: response.plan.id,\n    purchaseUrl: response.purchase_url,\n  };\n}\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;AAAA;;AAEA;;AAIA,IAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,EAAE;IAC7B,MAAM,IAAI,MAAM;AAClB;AAEO,MAAM,UAAU,IAAI,4JAAI,CAAC;IAC9B,KAAK;IACL,QAAQ,QAAQ,GAAG,CAAC,YAAY;IAChC,YAAY,KAAK,QAAQ,GAAG,CAAC,mBAAmB,IAAI;AACtD;AAGO,MAAM,sBAAsB,QAAQ,GAAG,CAAC,mBAAmB;AAU3D,eAAe,qBAAqB,MAM1C;IACC,IAAI,CAAC,qBAAqB;QACxB,MAAM,IAAI,MAAM;IAClB;IAEA,8DAA8D;IAC9D,MAAM,WAAW,MAAM,AAAC,QAAQ,SAAS,CAAS,MAAM,CAAC;QACvD,QAAQ;QACR,aAAa,OAAO,eAAe;QACnC,cAAc,OAAO,WAAW;QAChC,UAAU;QACV,aAAa,OAAO,WAAW;QAC/B,iBAAiB,OAAO,cAAc;QACtC,UAAU,OAAO,QAAQ;IAC3B;IAEA,OAAO;QACL,YAAY,SAAS,EAAE;QACvB,QAAQ,SAAS,MAAM,IAAI;IAC7B;AACF;AAKO,eAAe,kBACpB,UAAkB;IAElB,8DAA8D;IAC9D,MAAM,WAAW,MAAM,AAAC,QAAQ,SAAS,CAAS,QAAQ,CAAC;IAE3D,OAAO;QACL,QAAQ,SAAS,MAAM,IAAI;QAC3B,eACE,SAAS,MAAM,KAAK,WAAW,SAAS,eAAe,GAAG;IAC9D;AACF;AAOO,eAAe,qBAAqB,MAM1C;IACC,IAAI,CAAC,qBAAqB;QACxB,MAAM,IAAI,MAAM;IAClB;IAEA,oDAAoD;IACpD,wDAAwD;IACxD,MAAM,WAAW,MAAM,QAAQ,sBAAsB,CAAC,MAAM,CAAC;QAC3D,MAAM;YACJ,YAAY;YACZ,UAAU,OAAO,QAAQ;YACzB,eAAe,OAAO,WAAW,GAAG;YACpC,WAAW;YACX,OAAO,OAAO,IAAI;YAClB,YAAY;YACZ,SAAS;gBACP,qBAAqB,CAAC,aAAa,EAAE,KAAK,GAAG,IAAI;gBACjD,OAAO,OAAO,IAAI;gBAClB,eAAe;YACjB;QACF;QACA,UAAU,OAAO,QAAQ;QACzB,cAAc,OAAO,WAAW;IAClC;IAEA,IAAI,CAAC,YAAY,CAAC,SAAS,IAAI,EAAE;QAC/B,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO;QACL,IAAI,SAAS,EAAE;QACf,QAAQ,SAAS,IAAI,CAAC,EAAE;QACxB,aAAa,SAAS,YAAY;IACpC;AACF"}},
    {"offset": {"line": 171, "column": 0}, "map": {"version":3,"sources":["file:///Users/ivelinivanov/waliet/lib/utils.ts"],"sourcesContent":["import { clsx, type ClassValue } from \"clsx\";\nimport { twMerge } from \"tailwind-merge\";\n\n/**\n * Merge Tailwind classes with clsx\n */\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs));\n}\n\nexport function debounce<T extends (...args: unknown[]) => unknown>(\n  func: T,\n  wait: number\n): (...args: Parameters<T>) => void {\n  let timeout: ReturnType<typeof setTimeout> | null = null;\n  return (...args: Parameters<T>) => {\n    if (timeout) clearTimeout(timeout);\n    timeout = setTimeout(() => func(...args), wait);\n  };\n}\n\n/**\n * Format cents to dollar string\n */\nexport function formatCents(cents: number): string {\n  return new Intl.NumberFormat(\"en-US\", {\n    style: \"currency\",\n    currency: \"USD\",\n  }).format(cents / 100);\n}\n\n/**\n * Convert dollars to cents\n */\nexport function dollarsToCents(dollars: number): number {\n  return Math.round(dollars * 100);\n}\n\n/**\n * Convert cents to dollars\n */\nexport function centsToDollars(cents: number): number {\n  return cents / 100;\n}\n\n/**\n * Format units (30-min increments) to hours string\n */\nexport function formatUnitsToHours(units: number): string {\n  const hours = units / 2;\n  if (hours === 1) return \"1 hour\";\n  if (hours < 1) return `${units * 30} minutes`;\n  return `${hours} hours`;\n}\n\n/**\n * Default fee constants (in basis points)\n */\nexport const DEFAULT_PLATFORM_FEE_BPS = 800; // 8%\nexport const DEFAULT_COMMUNITY_FEE_BPS = 500; // 5%\nexport const MAX_TOTAL_FEE_BPS = 9000; // 90% - max allowed combined fees\n\n/**\n * Calculate fee from basis points\n */\nexport function calculateFeeFromBps(amount: number, bps: number): number {\n  return Math.round(amount * (bps / 10000));\n}\n\n/**\n * Calculate platform fee (8% default)\n */\nexport function calculatePlatformFee(amount: number, bps: number = DEFAULT_PLATFORM_FEE_BPS): number {\n  return calculateFeeFromBps(amount, bps);\n}\n\n/**\n * Calculate community fee in basis points\n */\nexport function calculateCommunityFee(amount: number, bps: number): number {\n  return calculateFeeFromBps(amount, bps);\n}\n\n/**\n * Format basis points as percentage string\n */\nexport function formatBpsAsPercent(bps: number): string {\n  return `${(bps / 100).toFixed(bps % 100 === 0 ? 0 : 1)}%`;\n}\n\n/**\n * Generate initials from name\n */\nexport function getInitials(name: string | null | undefined): string {\n  if (!name) return \"?\";\n  return name\n    .split(\" \")\n    .map((n) => n[0])\n    .join(\"\")\n    .toUpperCase()\n    .slice(0, 2);\n}\n\n/**\n * Format date for display\n */\nexport function formatDate(date: Date | string): string {\n  return new Intl.DateTimeFormat(\"en-US\", {\n    month: \"short\",\n    day: \"numeric\",\n    year: \"numeric\",\n  }).format(new Date(date));\n}\n\n/**\n * Format date with time\n */\nexport function formatDateTime(date: Date | string): string {\n  return new Intl.DateTimeFormat(\"en-US\", {\n    month: \"short\",\n    day: \"numeric\",\n    year: \"numeric\",\n    hour: \"numeric\",\n    minute: \"2-digit\",\n  }).format(new Date(date));\n}\n\n/**\n * Format relative time (e.g., \"2 hours ago\")\n */\nexport function formatRelativeTime(date: Date | string): string {\n  const now = new Date();\n  const then = new Date(date);\n  const diffMs = now.getTime() - then.getTime();\n  const diffSecs = Math.floor(diffMs / 1000);\n  const diffMins = Math.floor(diffSecs / 60);\n  const diffHours = Math.floor(diffMins / 60);\n  const diffDays = Math.floor(diffHours / 24);\n\n  if (diffSecs < 60) return \"just now\";\n  if (diffMins < 60) return `${diffMins}m ago`;\n  if (diffHours < 24) return `${diffHours}h ago`;\n  if (diffDays < 7) return `${diffDays}d ago`;\n  return formatDate(date);\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;;;AAKO,SAAS,GAAG,GAAG,MAAoB;IACxC,OAAO,IAAA,kLAAO,EAAC,IAAA,yJAAI,EAAC;AACtB;AAEO,SAAS,SACd,IAAO,EACP,IAAY;IAEZ,IAAI,UAAgD;IACpD,OAAO,CAAC,GAAG;QACT,IAAI,SAAS,aAAa;QAC1B,UAAU,WAAW,IAAM,QAAQ,OAAO;IAC5C;AACF;AAKO,SAAS,YAAY,KAAa;IACvC,OAAO,IAAI,KAAK,YAAY,CAAC,SAAS;QACpC,OAAO;QACP,UAAU;IACZ,GAAG,MAAM,CAAC,QAAQ;AACpB;AAKO,SAAS,eAAe,OAAe;IAC5C,OAAO,KAAK,KAAK,CAAC,UAAU;AAC9B;AAKO,SAAS,eAAe,KAAa;IAC1C,OAAO,QAAQ;AACjB;AAKO,SAAS,mBAAmB,KAAa;IAC9C,MAAM,QAAQ,QAAQ;IACtB,IAAI,UAAU,GAAG,OAAO;IACxB,IAAI,QAAQ,GAAG,OAAO,GAAG,QAAQ,GAAG,QAAQ,CAAC;IAC7C,OAAO,GAAG,MAAM,MAAM,CAAC;AACzB;AAKO,MAAM,2BAA2B,KAAK,KAAK;AAC3C,MAAM,4BAA4B,KAAK,KAAK;AAC5C,MAAM,oBAAoB,MAAM,kCAAkC;AAKlE,SAAS,oBAAoB,MAAc,EAAE,GAAW;IAC7D,OAAO,KAAK,KAAK,CAAC,SAAS,CAAC,MAAM,KAAK;AACzC;AAKO,SAAS,qBAAqB,MAAc,EAAE,MAAc,wBAAwB;IACzF,OAAO,oBAAoB,QAAQ;AACrC;AAKO,SAAS,sBAAsB,MAAc,EAAE,GAAW;IAC/D,OAAO,oBAAoB,QAAQ;AACrC;AAKO,SAAS,mBAAmB,GAAW;IAC5C,OAAO,GAAG,CAAC,MAAM,GAAG,EAAE,OAAO,CAAC,MAAM,QAAQ,IAAI,IAAI,GAAG,CAAC,CAAC;AAC3D;AAKO,SAAS,YAAY,IAA+B;IACzD,IAAI,CAAC,MAAM,OAAO;IAClB,OAAO,KACJ,KAAK,CAAC,KACN,GAAG,CAAC,CAAC,IAAM,CAAC,CAAC,EAAE,EACf,IAAI,CAAC,IACL,WAAW,GACX,KAAK,CAAC,GAAG;AACd;AAKO,SAAS,WAAW,IAAmB;IAC5C,OAAO,IAAI,KAAK,cAAc,CAAC,SAAS;QACtC,OAAO;QACP,KAAK;QACL,MAAM;IACR,GAAG,MAAM,CAAC,IAAI,KAAK;AACrB;AAKO,SAAS,eAAe,IAAmB;IAChD,OAAO,IAAI,KAAK,cAAc,CAAC,SAAS;QACtC,OAAO;QACP,KAAK;QACL,MAAM;QACN,MAAM;QACN,QAAQ;IACV,GAAG,MAAM,CAAC,IAAI,KAAK;AACrB;AAKO,SAAS,mBAAmB,IAAmB;IACpD,MAAM,MAAM,IAAI;IAChB,MAAM,OAAO,IAAI,KAAK;IACtB,MAAM,SAAS,IAAI,OAAO,KAAK,KAAK,OAAO;IAC3C,MAAM,WAAW,KAAK,KAAK,CAAC,SAAS;IACrC,MAAM,WAAW,KAAK,KAAK,CAAC,WAAW;IACvC,MAAM,YAAY,KAAK,KAAK,CAAC,WAAW;IACxC,MAAM,WAAW,KAAK,KAAK,CAAC,YAAY;IAExC,IAAI,WAAW,IAAI,OAAO;IAC1B,IAAI,WAAW,IAAI,OAAO,GAAG,SAAS,KAAK,CAAC;IAC5C,IAAI,YAAY,IAAI,OAAO,GAAG,UAAU,KAAK,CAAC;IAC9C,IAAI,WAAW,GAAG,OAAO,GAAG,SAAS,KAAK,CAAC;IAC3C,OAAO,WAAW;AACpB"}},
    {"offset": {"line": 294, "column": 0}, "map": {"version":3,"sources":["file:///Users/ivelinivanov/waliet/lib/commissions.ts"],"sourcesContent":["import { prisma } from \"@/lib/prisma\";\nimport { DEFAULT_PLATFORM_FEE_BPS, DEFAULT_COMMUNITY_FEE_BPS, MAX_TOTAL_FEE_BPS } from \"@/lib/utils\";\n\nexport interface EffectiveCommissionRates {\n  platformFeeBps: number;\n  communityFeeBps: number;\n  totalFeeBps: number;\n  source: {\n    platform: \"seller\" | \"community\" | \"default\";\n    community: \"seller\" | \"community\" | \"default\";\n  };\n}\n\n/**\n * Get effective commission rates for a seller in a community context\n * Priority: Seller-specific > Community-specific > Platform default\n */\nexport async function getEffectiveCommissionRates(\n  sellerId: string,\n  companyId?: string | null\n): Promise<EffectiveCommissionRates> {\n  // Fetch seller profile and community config in parallel\n  const [sellerProfile, communityConfig] = await Promise.all([\n    prisma.sellerProfile.findFirst({\n      where: { userId: sellerId },\n      select: {\n        customPlatformFeeBps: true,\n        customCommunityFeeBps: true,\n      },\n    }),\n    companyId\n      ? prisma.communityConfig.findUnique({\n          where: { whopCompanyId: companyId },\n          select: {\n            customPlatformFeeBps: true,\n            communityFeeBps: true,\n          },\n        })\n      : null,\n  ]);\n\n  // Determine platform fee (seller override > community override > default)\n  let platformFeeBps = DEFAULT_PLATFORM_FEE_BPS;\n  let platformSource: \"seller\" | \"community\" | \"default\" = \"default\";\n\n  if (sellerProfile?.customPlatformFeeBps !== null && sellerProfile?.customPlatformFeeBps !== undefined) {\n    platformFeeBps = sellerProfile.customPlatformFeeBps;\n    platformSource = \"seller\";\n  } else if (communityConfig?.customPlatformFeeBps !== null && communityConfig?.customPlatformFeeBps !== undefined) {\n    platformFeeBps = communityConfig.customPlatformFeeBps;\n    platformSource = \"community\";\n  }\n\n  // Determine community fee (seller override > community config > default)\n  let communityFeeBps = DEFAULT_COMMUNITY_FEE_BPS;\n  let communitySource: \"seller\" | \"community\" | \"default\" = \"default\";\n\n  if (sellerProfile?.customCommunityFeeBps !== null && sellerProfile?.customCommunityFeeBps !== undefined) {\n    communityFeeBps = sellerProfile.customCommunityFeeBps;\n    communitySource = \"seller\";\n  } else if (communityConfig?.communityFeeBps !== null && communityConfig?.communityFeeBps !== undefined) {\n    communityFeeBps = communityConfig.communityFeeBps;\n    communitySource = \"community\";\n  }\n\n  return {\n    platformFeeBps,\n    communityFeeBps,\n    totalFeeBps: platformFeeBps + communityFeeBps,\n    source: {\n      platform: platformSource,\n      community: communitySource,\n    },\n  };\n}\n\n/**\n * Validate that total fees don't exceed maximum\n */\nexport function validateCommissionRates(platformBps: number, communityBps: number): { valid: boolean; error?: string } {\n  if (platformBps < 0 || communityBps < 0) {\n    return { valid: false, error: \"Commission rates cannot be negative\" };\n  }\n\n  if (platformBps > MAX_TOTAL_FEE_BPS) {\n    return { valid: false, error: `Platform fee cannot exceed ${MAX_TOTAL_FEE_BPS / 100}%` };\n  }\n\n  if (communityBps > MAX_TOTAL_FEE_BPS) {\n    return { valid: false, error: `Community fee cannot exceed ${MAX_TOTAL_FEE_BPS / 100}%` };\n  }\n\n  const total = platformBps + communityBps;\n  if (total > MAX_TOTAL_FEE_BPS) {\n    return { valid: false, error: `Total fees (${total / 100}%) cannot exceed ${MAX_TOTAL_FEE_BPS / 100}%` };\n  }\n\n  return { valid: true };\n}\n\n/**\n * Set custom commission rate for a seller\n */\nexport async function setSellerCommissionRate(\n  sellerProfileId: string,\n  feeType: \"platform\" | \"community\",\n  newBps: number | null,\n  changedBy: string,\n  reason?: string\n): Promise<void> {\n  const sellerProfile = await prisma.sellerProfile.findUnique({\n    where: { id: sellerProfileId },\n    select: {\n      customPlatformFeeBps: true,\n      customCommunityFeeBps: true,\n    },\n  });\n\n  if (!sellerProfile) {\n    throw new Error(\"Seller profile not found\");\n  }\n\n  const previousBps = feeType === \"platform\"\n    ? sellerProfile.customPlatformFeeBps\n    : sellerProfile.customCommunityFeeBps;\n\n  // Validate the new rate if setting (not clearing)\n  if (newBps !== null) {\n    const otherBps = feeType === \"platform\"\n      ? (sellerProfile.customCommunityFeeBps ?? DEFAULT_COMMUNITY_FEE_BPS)\n      : (sellerProfile.customPlatformFeeBps ?? DEFAULT_PLATFORM_FEE_BPS);\n\n    const validation = validateCommissionRates(\n      feeType === \"platform\" ? newBps : otherBps,\n      feeType === \"community\" ? newBps : otherBps\n    );\n\n    if (!validation.valid) {\n      throw new Error(validation.error);\n    }\n  }\n\n  await prisma.$transaction([\n    // Update the seller profile\n    prisma.sellerProfile.update({\n      where: { id: sellerProfileId },\n      data: {\n        ...(feeType === \"platform\"\n          ? { customPlatformFeeBps: newBps }\n          : { customCommunityFeeBps: newBps }\n        ),\n        commissionUpdatedAt: new Date(),\n        commissionUpdatedBy: changedBy,\n      },\n    }),\n    // Create audit log\n    prisma.commissionChange.create({\n      data: {\n        sellerProfileId,\n        feeType,\n        previousBps,\n        newBps,\n        reason,\n        changedBy,\n      },\n    }),\n  ]);\n}\n\n/**\n * Set custom commission rate for a community\n */\nexport async function setCommunityCommissionRate(\n  communityConfigId: string,\n  feeType: \"platform\" | \"community\",\n  newBps: number | null,\n  changedBy: string,\n  reason?: string\n): Promise<void> {\n  const communityConfig = await prisma.communityConfig.findUnique({\n    where: { id: communityConfigId },\n    select: {\n      customPlatformFeeBps: true,\n      communityFeeBps: true,\n    },\n  });\n\n  if (!communityConfig) {\n    throw new Error(\"Community config not found\");\n  }\n\n  const previousBps = feeType === \"platform\"\n    ? communityConfig.customPlatformFeeBps\n    : communityConfig.communityFeeBps;\n\n  // Validate the new rate\n  if (newBps !== null) {\n    const otherBps = feeType === \"platform\"\n      ? communityConfig.communityFeeBps\n      : (communityConfig.customPlatformFeeBps ?? DEFAULT_PLATFORM_FEE_BPS);\n\n    const validation = validateCommissionRates(\n      feeType === \"platform\" ? newBps : otherBps,\n      feeType === \"community\" ? newBps : otherBps\n    );\n\n    if (!validation.valid) {\n      throw new Error(validation.error);\n    }\n  }\n\n  await prisma.$transaction([\n    // Update the community config\n    prisma.communityConfig.update({\n      where: { id: communityConfigId },\n      data: feeType === \"platform\"\n        ? { customPlatformFeeBps: newBps }\n        : { communityFeeBps: newBps ?? DEFAULT_COMMUNITY_FEE_BPS },\n    }),\n    // Create audit log\n    prisma.commissionChange.create({\n      data: {\n        communityConfigId,\n        feeType,\n        previousBps,\n        newBps,\n        reason,\n        changedBy,\n      },\n    }),\n  ]);\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 499, "column": 0}, "map": {"version":3,"sources":["file:///Users/ivelinivanov/waliet/app/api/sellers/commissions/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/prisma\";\nimport { whopsdk } from \"@/lib/whop-sdk\";\nimport { getEffectiveCommissionRates } from \"@/lib/commissions\";\nimport { DEFAULT_PLATFORM_FEE_BPS, DEFAULT_COMMUNITY_FEE_BPS } from \"@/lib/utils\";\n\n/**\n * GET /api/sellers/commissions\n * Get the effective commission rates for the authenticated seller\n */\nexport async function GET(request: NextRequest) {\n  try {\n    const { userId: whopUserId } = await whopsdk.verifyUserToken(request.headers);\n\n    const user = await prisma.user.findUnique({\n      where: { whopUserId },\n      include: { sellerProfile: true },\n    });\n\n    if (!user) {\n      return NextResponse.json({ error: \"User not found\" }, { status: 404 });\n    }\n\n    if (!user.sellerProfile) {\n      return NextResponse.json({ error: \"Seller profile not found\" }, { status: 404 });\n    }\n\n    // Get community context from query params (optional)\n    const { searchParams } = new URL(request.url);\n    const companyId = searchParams.get(\"companyId\");\n\n    // Get effective rates\n    const rates = await getEffectiveCommissionRates(user.id, companyId);\n\n    // Calculate net percentage the seller receives\n    const netPercentage = 100 - (rates.platformFeeBps + rates.communityFeeBps) / 100;\n\n    return NextResponse.json({\n      platformFeeBps: rates.platformFeeBps,\n      communityFeeBps: rates.communityFeeBps,\n      totalFeeBps: rates.totalFeeBps,\n      netPercentage,\n      source: rates.source,\n      defaults: {\n        platformFeeBps: DEFAULT_PLATFORM_FEE_BPS,\n        communityFeeBps: DEFAULT_COMMUNITY_FEE_BPS,\n      },\n      hasCustomRate:\n        rates.source.platform !== \"default\" || rates.source.community !== \"default\",\n    });\n  } catch (error) {\n    console.error(\"Error fetching commission rates:\", error);\n    return NextResponse.json({ error: \"Failed to fetch commission rates\" }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;;;;;;;;;;;AAMO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,EAAE,QAAQ,UAAU,EAAE,GAAG,MAAM,yIAAO,CAAC,eAAe,CAAC,QAAQ,OAAO;QAE5E,MAAM,OAAO,MAAM,mIAAM,CAAC,IAAI,CAAC,UAAU,CAAC;YACxC,OAAO;gBAAE;YAAW;YACpB,SAAS;gBAAE,eAAe;YAAK;QACjC;QAEA,IAAI,CAAC,MAAM;YACT,OAAO,0JAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,IAAI,CAAC,KAAK,aAAa,EAAE;YACvB,OAAO,0JAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA2B,GAAG;gBAAE,QAAQ;YAAI;QAChF;QAEA,qDAAqD;QACrD,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,YAAY,aAAa,GAAG,CAAC;QAEnC,sBAAsB;QACtB,MAAM,QAAQ,MAAM,IAAA,6JAA2B,EAAC,KAAK,EAAE,EAAE;QAEzD,+CAA+C;QAC/C,MAAM,gBAAgB,MAAM,CAAC,MAAM,cAAc,GAAG,MAAM,eAAe,IAAI;QAE7E,OAAO,0JAAY,CAAC,IAAI,CAAC;YACvB,gBAAgB,MAAM,cAAc;YACpC,iBAAiB,MAAM,eAAe;YACtC,aAAa,MAAM,WAAW;YAC9B;YACA,QAAQ,MAAM,MAAM;YACpB,UAAU;gBACR,gBAAgB,oJAAwB;gBACxC,iBAAiB,qJAAyB;YAC5C;YACA,eACE,MAAM,MAAM,CAAC,QAAQ,KAAK,aAAa,MAAM,MAAM,CAAC,SAAS,KAAK;QACtE;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,oCAAoC;QAClD,OAAO,0JAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAmC,GAAG;YAAE,QAAQ;QAAI;IACxF;AACF"}}]
}